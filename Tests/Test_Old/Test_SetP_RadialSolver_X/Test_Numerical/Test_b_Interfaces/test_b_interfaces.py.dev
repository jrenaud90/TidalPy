""" Test the `TidalPy.radial_solver.interfaces` (cython extension) functionality. """

import pytest
import numpy as np

import TidalPy

TidalPy.test_mode()

from TidalPy.radial_solver.numerical.interfaces.interfaces_x import find_solution_num, interface_x


@pytest.mark.parametrize('lower_is_solid', (True, False))
@pytest.mark.parametrize('lower_is_static', (True, False))
@pytest.mark.parametrize('lower_is_incompressible', (True, False))
@pytest.mark.parametrize('upper_is_solid', (True, False))
@pytest.mark.parametrize('upper_is_static', (True, False))
@pytest.mark.parametrize('upper_is_incompressible', (False, True))
def test_interfaces(lower_is_solid, lower_is_static, lower_is_incompressible,
                    upper_is_solid, upper_is_static, upper_is_incompressible):
    """ Test interface function """

    upper_equals_lower = True
    if upper_is_solid != lower_is_solid:
        upper_equals_lower = False
    elif upper_is_static != lower_is_static:
        upper_equals_lower = False
    elif upper_is_incompressible != lower_is_incompressible:
        upper_equals_lower = False

    if lower_is_solid:
        if lower_is_static:
            if lower_is_incompressible:
                # TODO: Confirm
                y_lower = np.asarray((
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        ),
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        ),
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        )
                    ), dtype=np.complex128)
            else:
                y_lower = np.asarray((
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        ),
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        ),
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        )
                    ), dtype=np.complex128)
        else:
            # Dynamic
            if lower_is_incompressible:
                # TODO: Confirm
                y_lower = np.asarray((
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        ),
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        ),
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        )
                    ), dtype=np.complex128)
            else:
                y_lower = np.asarray((
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        ),
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        ),
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        )
                    ), dtype=np.complex128)
    else:
        # Liquid
        if lower_is_static:
            if lower_is_incompressible:
                # TODO: Confirm
                y_lower = np.asarray((
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        )
                    ), dtype=np.complex128)
            else:
                y_lower = np.asarray((
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        )
                ), dtype=np.complex128)
        else:
            # Dynamic
            if lower_is_incompressible:
                # TODO: Confirm
                y_lower = np.asarray((
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        ),
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        )
                    ), dtype=np.complex128)
            else:
                y_lower = np.asarray((
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        ),
                    (
                        1.0 + 2.0j,
                        3.0 + 2.0j,
                        1.0 + 2.0j,
                        3.0 + 2.0j
                        )
                    ), dtype=np.complex128)

    interface_gravity = 4.0
    liquid_density = 3000.

    upper_sols = find_solution_num(upper_is_solid, upper_is_static, upper_is_incompressible)
    y_upper = np.empty((upper_sols, upper_sols*2), dtype=np.complex128)

    interface_x(y_lower, y_upper,
                lower_is_solid, lower_is_static, lower_is_incompressible,
                upper_is_solid, upper_is_static, upper_is_incompressible,
                interface_gravity, liquid_density)

    if upper_equals_lower:
        if not np.all(y_lower == y_upper):
            breakpoint()
        assert np.all(y_lower == y_upper)

    # TODO: These tests do not currently check that values are correct.
